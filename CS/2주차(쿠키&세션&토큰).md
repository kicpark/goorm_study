# 쿠키

## 쿠키란?
상태가 없는(stateless) HTTP 프로토콜에서 상태 정보를 기억시켜주는 한 방법입니다.
쿠키는 사용자를 기억하기 위해 서버에서 브라우저 단위로 저장을 하는 key-value형태의 데이터이다.
브라우저 단위로 기억하기 때문에 같은 디바이스에서도 다른 브라우저로 접속하면 기존에 있던 쿠키를 사용할 수 없다.

## 쿠키의 주  사용 용도
- 세션 관리(Session management)
 서버에 저장해야 할 로그인, 장바구니, 게임 스코어 등의 정보 관리
- 개인화(Personalization)
사용자 선호, 테마 등의 세팅
- 트래킹(Tracking)
사용자 행동을 기록하고 분석하는 용도

## 쿠키의 동작 방식
![Untitled](https://joongbu.raonctf.com/static/essential/images/network/network_cookie_01.jpg)
1. 클라이언트가 서버에 요청(Request)를 보낸다.
2. 서버가 필요에 의해 쿠키를 생성하여 클라이언트에 응답(Response)를 보낸다.
3. 클라이언트가 서버에 쿠키를 이용하여 자신의 상태를 실어서 요청(Request)를 보낸다.
4. 필요하다면 서버에서 쿠키의 데이터를 업데이트하여 응답(Response)한다.

## 쿠키의 라이프타임
쿠키의 라이타임은 두가지 방법으로 정의할수 있습니다.
- 쿠키는 현재 세션이 끝날 때 삭제됩니다. 브라우저는 "현재 세션"이 끝나는 시점을 정의하며, 어떤 브라우저들은 재시작할 때 세션을 복원해 세션 쿠키가 무기한 존재할 수 있도록 합니다.
- 영속적인 쿠키는 Expires 속성에 명시된 날짜에 삭제되거나, Max-Age 속성에 명시된 기간 이후에 삭제됩니다.

# 세션

## 왜 세션을 사용할까?
회원가입 및 로그인 기능을 만들었다면 난관에 부딪히게 됩니다.
![Untitled](https://hongong.hanbit.co.kr/wp-content/uploads/2022/05/%EC%84%9C%EB%B2%84%EA%B0%80-%EB%82%98%EB%A5%BC-%EC%95%8C%EC%95%84%EB%B3%B4%EB%8A%94-%EB%B0%A9%EB%B2%95-%EC%84%B8%EC%85%98.png)
바로 Stateless관한 문제입니다.
이를 크게 두 가지로 나누자면
- 요청한 사용자는 누구인가?
- 사용자의 로그인 상태를 어떻게 관리할것인가?

이를 해결하는 가장 대표적인 방법이 세션입니다.

## 세션의 동작 방식
![Untitled](https://oopy.lazyrockets.com/api/v2/notion/image?src=https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0be0e707-ebc5-4bf9-a163-c9167e7d098f%2FUntitled.png&blockId=630a2507-6abf-4012-83b5-3024baeeb371)
1. 클라이언트가 로그인을 시도한다.
2. 서버에서 인증 절차를 완료한 후 세션DB에 세션 ID생성 및 저장을 한다.
3. 생성된 sesssionId를 쿠키에 담아 클라이언트에게 보낸다.
4. 클라이언트가 새로운 요청이 있을 경우 세션ID를 쿠키에 담아 요청을 보낸다.
5. 서버는 세션ID의 유효성을 검사한 후 로직을 실행한다.


## 토큰
토큰은 안드로이드와 IOS같은 네이티브앱에서는 쿠키를 사용할 수 없는 문제를 해결하기 위해 등장한 문자열형식의 데이터입니다.
주로 세션ID를 주고 받을 때 사용합니다.
## JWT
JWT는 토큰형식의 인증방식으로 세션DB를 필요로하지 않습니다.

### JWT동작 방식
![Untitled](https://oopy.lazyrockets.com/api/v2/notion/image?src=https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7b98e358-c023-437d-963f-66aa3ad19155%2FUntitled.png&blockId=09506e10-b2e4-40e0-b6aa-63a1f23f7c1b)
1. 클라이언트가 로그인 요청을 보낸다.
2. 서버가 인증을 마치고 난뒤 JWT토큰을 발행한다.
3. 사용자가 새로운 요청을 할 때 발행되었던 JWT 토큰을 함께 보내준다.
4. 서버는 JWT토큰의 유효성을 검사하여 로직을 처리한다.

서버는 각 로그인마다 사용자에 대한 정보를 저장하지 않고 JWT의 유효성만 검사하기 때문에 더 간편하고 가볍게 구현할 수 있습니다.

## 세션과 JWT의장단점
### 세션의 장점
1. 사용자의 정보를 서버에서 관리하기 때문에 보안상 안전하다.
2. 사용자에 대한 추적이 가능하기 때문에 모든 유저의 행동을 관리하에 둘 수 있게 된다.

### 세션의 단점
1. 모든 로그인된 사용자의 정보를 저장하기 위해 필요한 DB의 규모가 유저수에 따라 증가하게된다.
2. 요청이 들어올 때마다 DB를 서치해야 해서 자원관리에 힘이 든다.

### JWT의 장점
1. 사용자의 정보를 서버에서 관리하기 때문에 보안상 안전하다.
2. DB에 저장하거나 서치할 필요가 없기 때문에 쉽고 간편하게 구현 및 인증이 가능하다.

### JWT의 단점
1. 사용자에 대한 추적이 불가능하다.
2. JWT토큰을 탈취 당하면 누구나 인증이 가능하기 때문에 보안상 취약점이 있다.

## 로그인 유지 방식에 대한 차이점
### 쿠키 vs 세션 & JWT
세션과 JWT는 사용자의 정보를 서버에 저장합니다.
앞서 말했던 쿠키는 사용자 정보를 클라이언트에 저장하기 때문에 탈취당하기 쉬우며 쿠키안에 있는 데이터 또한 변조하기 쉽습니다.
보안성을 위해 쿠키를 이용한 로그인 유지 방식은 추천하지 않습니다.
### 세션 & JWT
Q. 구현도 쉽고 비용도 덜 들며 보다 새롭게 나온 JWT방식이 더 좋은가요?
A. JWT방식이 더 간편하기는 하지만 항상 같은 문자열에 대하여 같은 암호화 알고리즘을 사용하기 때문에 누구나 쉽게 열람이 가능하며 서버에서는 JWT토큰의 유효성을 검사할 뿐 검사받는 사용자에 대한 정보가 없어 관리에 힘이 듭니다.
대표적인 예시로 사용자의 친구목록을 불러오는 기능, 동시에 다른 디바이스에서 같은 사용자의 접속을 막는 기능 등을 구현 할때는 세션&쿠키 방식이 옳습니다.

Q. 그러면 항상 세션방식을 택해야하나요?
A. 그렇지 않습니다. 세션방식은 보다 안전하고 기능이 많기는 하나 요청이 올 때마다 DB를 검색해야하는 단점을 지녔습니다.
QR코드 인증과 같은 짧은 시간에 해결해야하는 인증을 구현할때는 JWT를 이용하는 것이 더 효율적입니다.


## 공부하면서 느낀 점
1. 쿠키vs세션인줄 알고 공부했지만 사실 쿠키와 세션을 같은편이고 JWT와 세션의 대결이었다.
2. 세션의 단점 JWT의 단점을 해결하기 위한 방법은 추가적인 공부가 필요하며, 대략적으로 세션은 REDIS를 JWT는 Refrest token을 사용한다.

참고자료
https://www.youtube.com/watch?v=tosLBcAX1vk
https://developer.mozilla.org/ko/docs/Web/HTTP/Cookies
